### TLS
[[31. TLS. Handshake. ClientHello. ServerHello. Random. Cipher Suites. SessionID.]]

### Handshake v 1.3. Особенности
В TLS 1.3 от предыдущих версий унаследованы только базовые принципы установления соединения: сохранились роли узлов (соединение инициирует клиент), не изменилась последовательность ClientHello - ServerHello, присутствует сообщение-сигнал Finished. Однако на этом сходство заканчивается. В TLS 1.3 сокращено и общее число сообщений Handshake, и число сообщений, передаваемых в открытом виде: узлы практически сразу переходят на зашифрованный обмен. Поэтому из схемы установления соединения удалён сигнал ChangeCipherSpec - он больше не требуется (как ни странно, cам "сигнал" при этом остался и может передаваться узлами, см. ниже). Изменилась роль сообщения CertificateVerify - при передаче со стороны сервера оно удостоверяет сообщения первой части Handshake.

![[Screenshot 2024-12-23 at 21.00.21.png]]

В протоколе установления соединения TLS 1.3 выделяются три фазы: выработка начального значения общего криптографического секрета (ключей), определение параметров соединения, аутентификация (сервера и клиента).

К первой фазе относятся ClientHello и ServerHello (а также их расширения, обозначенные на схеме символом '+'). Результатом обмена сообщениями в первой фазе является получение первого секрета (в терминах спецификации исходный секрет называется handshake_traffic_secret). На основе этого секрета, используя дополнительно сами сообщения, переданные к этому моменту, стороны получают первый набор симметричных ключей. Эти ключи предназначены для зашифрования сообщений Handshake, начиная с серверного EncryptedExtensions. Например, серверный сертификат в TLS 1.3 передаётся в зашифрованном виде. Это означает, что сторона, прослушивающая канал связи, но не имеющая ключей, не сможет определить, что за сертификат был предоставлен сервером (и был ли он предоставлен вообще - истинная длина сообщений может быть скрыта при помощи дополнения их нулевыми байтами, это также определено спецификацией 1.3). Первая фаза завершается передачей ServerHello и обязательных расширений.

Вторая фаза включает серверные сообщения EncryptedExtensions и, при необходимости аутентификации клиента, CertificateRequest. Новое сообщение - EncryptedExtensions - добавлено в TLS 1.3.

В третьей фазе, представленной группами сообщений Certificate, CertificateVerify и Finished, происходит аутентификация сервера и клиента. Как и в предыдущих версиях TLS, аутентификация может быть полностью исключена (анонимный режим), однако типичный сценарий использования подразумевает, по крайней мере, аутентификацию сервера клиентом. При этом в TLS 1.3 сервер может перейти к отправке данных полезной нагрузки (Application Data на схеме) непосредственно после серверного Finished - это возможно потому, что к этому моменту сервером уже получен первый набор симметричных ключей.

Сравним новую схему с TLS 1.2. Кроме уже упомянутого выше отсутствия сигнала ChangeCipherSpec, отсутствуют сообщения ClientKeyExchange, ServerKeyExchange и ServerHelloDone. При этом параметры, необходимые для построения криптографического контекста, из ClientKeyExchange и ServerKeyExchange перекочевали в расширения ClientHello и ServerHello: это key_share, supported_groups, а также signature_algorithms, psk_key_exchange_modes и pre_shared_key. В типичной ситуации, непосредственно для выработки криптографического контекста используются расширения supported_groups и key_share: первое содержит идентификаторы групп, используемых для протокола Диффи-Хеллмана; второе - открытый ключ или несколько открытых ключей (взятых в группах, перечисленных в supported_groups). Так как установление соединения TLS 1.3 проводится в защищённом режиме, расширения, содержащие криптографические параметры, необходимы. Более того, их наличие (вместе с supported_versions) - является необходимым признаком TLS 1.3. Криптографические операции TLS 1.3 рассмотрим подробно ниже, в специальном разделе.

Сообщение-сигнал ServerHelloDone (оно в предыдущих версиях имело нулевую длину и обозначало окончание первой партии серверных сообщений Handshake) заменено на серверное Finished.

### Защищенные сообщения в TLS 1.3
ServerHello, при штатном ходе установления соединения, является единственным сообщением сервера, которое передаётся в открытом виде. Уже следующее сообщение - EncryptedExtensions - зашифровано. Зашифрованные сообщения в TLS 1.3 передаются строго внутри TLS-записей с типом Application Data (0x17). Это ещё одно важное отличие от предыдущих версий.


### Шифронаборы
TLS использует для защиты информации шифронаборы. Шифронабор (Cipher Suite) позволяет обеспечить не только сокрытие информации, но и её целостность. В состав шифронабора входит симметричный шифр. С его помощью осуществляется зашифрование потока данных, передаваемых через TLS-сокет. Возможно использование TLS без шифрования, однако это не является распространённым случаем.

В терминологии TLS существуют зашифровывающие и расшифровывающие функции. Эти функции работают с криптографическим контекстом соединения, о котором договорились узлы. После того, как узлы обменялись сообщениями ChangeCipherSpec (см. выше), все TLS-сообщения зашифрованы, а в TLS 1.3 шифрование включается даже раньше. Зашифровывающая функция преобразует открытый текст, подготовленный для отправки в составе TLS-записи (строго говоря, после сжатия, но, как рассказано выше, в современной реальности TLS сжатие не используется), в секретный текст (зашифрованный). Расшифровывающая функция выполняет обратное преобразование. Для того, чтобы зашифровывающие и расшифровывающие функции успешно работали на обоих узлах, требуется выработка общего криптографического контекста - это происходит в рамках обмена сообщениями Handshake. В TLS могут использоваться и потоковые, и блочные шифры, последние - в различных режимах. Обычно, зашифровывающие и расшифровывающие функции являются одним симметричным шифром и различаются только составом ключей. TLS 1.3 _существенно_ ужесточает принципы включения шифронаборов в реализации, фактически, в действующей версии 1.3 допущены только два шифра: AES и ChaCha20.