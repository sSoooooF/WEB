### Деплой на множестве серверов
База данных одновременно живет с несколькими версиями приложения. Мы не можем сказать базе данных удалить какое-либо поле из схемы базы данных, потому что, когда бы откатимся этого поля не будет и все рухнет. Поэтому изменения данных приходится прокатывать отдельно и только вверх. Удалять что-либо из базы данных можно только тогда, когда старый код уже удален.
![[Pasted image 20241223235430.png]]

### Миграции


### Blue-green, скользящий деплой, канарейка

**Blue/green деплой**

У нас есть несколько сред, и они дублируют друг друга. У нас есть prod (синий) и staging (зеленый). На проде стоят все приложения, которые есть в нашей среде. Они все версии 1.0.1. А зеленая среда уже обновилась, и мы подняли приложения до следующей версии во всех копиях. При деплое переключаем трафик с синей на зеленую. Если что-то не так, переключаем обратно. Минус – необходимо в два раза больше серверов.![[Pasted image 20241223235457.png]]

**Скользящий деплой**

Это деплой по всем серверам по цепочке. Есть три копии приложения с версией 1.0.1. При деплое мы снимем трафик с первого приложения, обновляем до версии 1.0.2 и пускаем трафик. И так далее с оставшимися приложениями.

Но есть одна большая проблема, когда часть серверов на новой версии, а часть еще на старой. Тем временем один и тот же пользователь может зайти в рамках одной и той же страницы как на новую версию, так и на старую. Исходя из этого, новая версия не должна ломать работу старой версии. 
![[Pasted image 20241223235514.png]]

При необходимости откатиться нужно либо откатываться постепенно (что медленно), либо использовать скользящий деплой с «канарейкой»

**Канарейка**

При использовании канарейки на один из серверов ставится новая версия («канареечная») и на него дается чуть-чуть трафика. Все запросы этого небольшого количества людей должны идти только на «канареечную» версию, а не старые. Это делается через липкие сессии с помощью app-cookie, http-cookie или ip. Данный метод может работать как со скользящим деплоем, так и с blue/green.


### Проблемы версионности.